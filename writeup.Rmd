---
title: "Ferry Curious or How I learned to stop worrying and accept WSDOT"
author: "From your friends at SLED analytics"
output: 
  html_document:
    fig_caption: true
---

We have long been interested in WSDOT ferry data, specifically on-time rates, and finally decided to file a Public Records Request in an attempt to gain access to this data. Here we present findings for on-time rates for calendar year 2014.

First, a few caveats: Because WSDOT runs a [holiday schedule](http://www.wsdot.wa.gov/Ferries/infodesk/faq/general_info/) on most Federal holidays, we specially accounted for those specific dates. Also, for this report we solely focused on the routes in Central Puget Sound (ie non-Orcas Islands routes).

##On time departures
WSDOT uses GPS trackers on each ferry and is therefore able to record arrival and departure times to the second, so we initially looked at the difference in scheduled departure time vs. actual departure time.

```{r, echo=FALSE, fig.width=6, fig.cap="*Figure 1*: Each point represents the mean departure delay on that date for all ferry routes with a trend line overlaid."}
suppressPackageStartupMessages(library(dplyr))
library(ggplot2)

`%notin%` <- function(x,y) !(x %in% y)

raw <- read.csv("data/PDR-15-1195.csv", colClasses="character")
raw$scheduled_departure_dt <- as.POSIXlt(raw$scheduled_departure)
raw$scheduled_departure <- as.Date(raw$scheduled_departure)
raw$actual_departure_dt <- as.POSIXlt(raw$actual_departure)
raw$scheduled_hour <- raw$scheduled_departure_dt$hour
raw$difference <- as.numeric(difftime(raw$actual_departure, raw$scheduled_departure_dt, units = "min"))
raw$departure_date <- as.Date(raw$scheduled_departure)

#classify days in raw data set
raw$wday <- raw$scheduled_departure_dt$wday
raw$day <- "Weekday"
raw$day[raw$wday == 0 | raw$wday == 6] <- "Weekend"

holidays <- as.Date(c("2014-01-01", "2014-01-20", "2014-02-17",
                      "2014-05-26", "2014-07-04", "2014-09-01",
                      "2014-10-13", "2014-11-11",
                      "2014-11-27", "2014-12-25"))
raw$day[raw$departure_date %in% holidays] <- "Holiday"

raw$delay <- abs(raw$difference)
raw$delay[raw$difference < 0] <- NA

pugetSound <- c("Fauntleroy - Southworth",
                "Fauntleroy - Vashon",
                "Mukilteo - Clinton",
                "Pt. Defiance - Tahlequah",
                "Seattle - Bainbridge Island",
                "Seattle - Bremerton",
                "Southworth - Vashon",
                "Keystone - Port Townsend")

all.days <-
  raw %>%
  subset(route_name %in% pugetSound) %>%
  select(scheduled_departure, route_name, difference) %>%
  group_by(scheduled_departure, route_name) %>%
  summarise_each(funs(mean), difference)

ggplot(all.days, aes(scheduled_departure, difference)) +
  geom_point(size=0.3) + stat_smooth() + xlab("Scheduled departure date") +
  ylab("Difference in actual vs. scheduled departure time")
```

In Figure 1, we used linear regression to add a trend line to graphically show any trends present in departure time delay. As a whole, the data shows minimal variation in departure time with a large bump in departure delay towards the end of summer. In 2014, the average daily depature delay was approximately 3 minutes for all ferry routes of interest.

##On time departures by route
```{r, echo=FALSE, fig.cap="*Figure 2*: Difference in scheduled departure time vs. actual departure time stratified by route."}
ggplot(all.days, aes(scheduled_departure, difference)) + geom_point(size=0.3) + stat_smooth() +
  scale_x_date(labels = scales::date_format("%b")) +
  facet_wrap(~route_name) + xlab("Scheduled Departure Date") +
  ylab("Minutes Difference between Scheduled and Actual Departure")
```

##On time rates based on day
```{r, echo=FALSE, fig.width=8, fig.height=6, fig.cap="*Figure 3*: Difference in scheduled departure time vs. actual departure time by day"}


pugetSoundRoutes <- 
  raw %>%
  subset(delay >= 0 & route_name %in% pugetSound) 

hour.levels <- rev(0:23)
pugetSoundRoutes$scheduled_hour <- factor(pugetSoundRoutes$scheduled_hour, levels = 23:0, ordered=T)
names(pugetSoundRoutes)[14:15] <- c("Day", "Delay")

ggplot(pugetSoundRoutes) + 
  geom_point(aes(departure_date, scheduled_hour, size = Delay, col = Day)) +
  facet_wrap(~route_name) + 
  scale_size_continuous(range = c(.1, 6)) + 
  ggtitle("Delays for All 2014 Puget Sound Sailings")+
  scale_x_date(labels = scales::date_format("%b")) +
  xlab("Departure Date") + ylab("Scheduled Hour of Departure") +
  scale_y_discrete(breaks = c(0, 5, 9, 13, 17, 20, 23), labels = c("Midnight", "5 am", "9 am", "1 pm", "5 pm", "8pm", "11pm"))
  
```

Again we see the same patterns of variance in departure delay as observed in Figure 2 but we can also see that certain routes (e.g. Seattle - Bainbridge Island) tend to have more delays on the weekend sailings while other routes such as Keystone - Port Townsend tend to have more departure delays during the week.

##Seattle - Bainbridge Island
```{r, echo=FALSE, fig.cap="*Figure 4*: Delay in departure for Seattle - Bainbridge Island route"}
bi.only <- subset(pugetSoundRoutes, route_name == "Seattle - Bainbridge Island")
ggplot(bi.only) + 
  geom_point(aes(departure_date, scheduled_hour, size = Delay, col = Day)) +
  facet_wrap(~route_name) + 
  scale_size_continuous(range = c(.1, 6)) + 
  ggtitle("Delays for All 2014 Sailings")+
  scale_x_date(labels = scales::date_format("%b")) +
  xlab("Departure Date") + ylab("Scheduled Hour of Departure") +
  scale_y_discrete(breaks = c(0, 5, 9, 13, 17, 20, 23), labels = c("Midnight", "5 am", "9 am", "1 pm", "5 pm", "8pm", "11pm"))
```

##Summaries for specific ferry boats
```{r, echo=FALSE, fig.width=8, fig.height=6, fig.cap="*Figure 5*: Weekly min, max, and departure delays by ferry boat"}

cleaned <- 
  raw %>% 
  subset(difference < 100 & difference >= 0 & route_name %in% pugetSound)
                 
cleaned$week <- lubridate::week(cleaned$departure_date)
weekly <- do.call('rbind', by(cleaned, interaction(cleaned$week, cleaned$actual_vessel_name), function(x) {
  data.frame("min" = min(x$difference), 
             "max" = max(x$difference), 
             "median" = median(x$difference),
             "week" = x$week[1],
             "vessel" = x$actual_vessel_name[1])
}))

wlong <- reshape2::melt(weekly, id.vars = c("week", "vessel"))
ggplot(wlong) + 
  geom_line(aes(x = week, y = value, linetype = variable)) + 
  facet_wrap(~vessel) + 
  ggtitle("Weekly departure delays by boat") +
  xlab("Week of Year") + ylab("Minutes Difference between Actual Departure and Scheduled Departure") + 
  scale_linetype_manual(name = "Weekly Summaries", values = c("dotted", "dashed", "solid"))
```

WSDOT also tracks which boat is used on each route which allows for a look at overall  efficiencies for each ferry boat.

##Average crossing times
```{r, echo=FALSE, fig.cap="*Figure 6*: Average crossing time by route"}
raw <- 
  raw %>%
  subset(Actual_Arrival != "NULL")
raw$actual_arrival <- as.Date(raw$Actual_Arrival)
raw$actual_arrival_dt <- as.POSIXlt(raw$Actual_Arrival)
raw$crossing <- as.numeric(difftime(raw$actual_arrival_dt, raw$actual_departure_dt, units = "min"))
mean.times <-
  raw %>%
  subset(route_name %in% pugetSound) %>%
  select(scheduled_departure, route_name, crossing) %>%
  group_by(scheduled_departure, route_name) %>%
  summarise_each(funs(mean), crossing)

ggplot(mean.times, aes(scheduled_departure, crossing)) + geom_point(size=0.3) + stat_smooth() +
  scale_x_date(labels = scales::date_format("%b")) +
  facet_wrap(~route_name) + xlab("Scheduled Departure Date") +
  ylab("Average crossing time in minutes")
```

Figure 6 shows that most ferries are very consistent after departure with the exception of the Fauntleroy - Southworth and Keystone - Port Townsend routes, which both show a fair amount of variation. Because this figure only looks at crossing times, any variation in trip length is due to factors that occurred while sailing.

##Conclusion
In conclusion, we observed that WSDOT ferries are generally very consistent and there is some ability to predict delays in advance (such as a summer weekend afternoon sailing). Ideally we would have been able to add external covariates such as weather or automobile traffic which might have been informative in helping to further explain these trends.